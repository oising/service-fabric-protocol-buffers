<Project ToolsVersion="4.0" DefaultTargets="Build" 
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <ItemGroup>
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)SceneSkope.ProtocolBuffers.Tools.xaml" />
    <PropertyPageSchema Include="$(MSBuildThisFileDirectory)SceneSkope.ProtocolBuffers.Tools.ContentType.xaml" />
    <AvailableItemName Include="ProtoDef"/>
  </ItemGroup>

  <PropertyGroup>
    <CoreCompileDependsOn>
      GenerateProtoCode;
      $(CoreCompileDependsOn)
    </CoreCompileDependsOn>
  </PropertyGroup>

  <ItemGroup>
    <ProtocGenCs Include="@(ProtoDef -> '%(FileName).cs')">
      <AutoGen>true</AutoGen>
      <DependentUpon>%(FileName).proto</DependentUpon>
    </ProtocGenCs>
    <Compile Remove="@(ProtocGenCs)" />
  </ItemGroup>

  <PropertyGroup>
    <NoWarn>$(NoWarn);RCS1168</NoWarn>
  </PropertyGroup>

  <Target Name="GenerateProtoCode" BeforeTargets="BeforeBuild" Outputs="@(ProtocGenCs)" BeforeTargets="CoreCompile"
          Condition=" '@(ProtoDef)' != '' ">
    <Message Text="Running protoc on @(ProtoDef)" Importance="High"/>
    <PropertyGroup>
      <ProtobufTools>$(NugetPackageRoot)google.protobuf.tools\$(ProtocolBuffersToolVersion)</ProtobufTools>
    </PropertyGroup>
    <PropertyGroup>
      <ProtobufToolsPath>$(ProtobufTools)\tools\$(ProtocolBuffersToolOs)_$(ProtocolBuffersToolArch)</ProtobufToolsPath>
      <ProtobufIncludePath>-I $(ProtobufTools)\tools</ProtobufIncludePath>
    </PropertyGroup>
    <Message Text="Cannot find protobuf tools @ $(ProtobufToolsPath)" Importance="High" Condition="!Exists('$(ProtobufToolsPath)/protoc.exe')" />
    <Exec Command="$(ProtobufToolsPath)/protoc.exe -I . $(ProtobufIncludePath) $(ProtobufExtraIncludePath) --csharp_out . %(ProtocCodegen.Identity)"
      Condition="Exists('$(ProtobufToolsPath)/protoc.exe')" />

    <ItemGroup>
      <Compile Include="@(ProtocGenCs)" />
    </ItemGroup>
  </Target>
</Project>

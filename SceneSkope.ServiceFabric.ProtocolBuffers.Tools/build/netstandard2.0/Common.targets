<Project ToolsVersion="4.0" DefaultTargets="Build" 
  xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <NoWarn>$(NoWarn);RCS1168</NoWarn>
  </PropertyGroup>
  <ItemGroup>
    <ProtocCodegen Include="*.proto" />
  </ItemGroup>
  <Target Name="ProtocSetup" BeforeTargets="BeforeClean;RunGrpc">
    <ItemGroup>
      <ProtocGenCs Include="@(ProtocCodegen -> '%(FileName).cs')">
        <AutoGen>true</AutoGen>
        <DependentUpon>%(FileName).proto</DependentUpon>
      </ProtocGenCs>
      <ProtocGenGrpcCs Include="@(ProtocCodegen -> '%(FileName)Grpc.cs')">
        <DependentUpon>$([System.String]::Copy('%(FileName).proto').Replace("Grpc", ""))</DependentUpon>
        <AutoGen>true</AutoGen>
      </ProtocGenGrpcCs>
    </ItemGroup>
    <ItemGroup>
      <FileWrites Include="@(ProtocGenCs);@(ProtocGenGrpcCs)" />
      <Compile Remove="@(ProtocGenCs)" />
      <Compile Remove="@(ProtocGenGrpcCs)" Condition="Exists('%(Identity)')" />
    </ItemGroup>
  </Target>
  <Target Name="RunGrpc" Inputs="@(ProtocCodegen)" Outputs="@(ProtocGenCs);@(ProtocGenGrpcCs)" BeforeTargets="CoreCompile" DependsOnTargets="ResolvePackageDependenciesForBuild" Condition=" '@(ProtocCodegen)' != '' ">
    <PropertyGroup>
      <GrpcTools>$(NugetPackageRoot)grpc.tools\$(GrpcToolVersion)</GrpcTools>
      <ProtobufTools>$(NugetPackageRoot)google.protobuf.tools\$(ProtoToolVersion)</ProtobufTools>
    </PropertyGroup>
    <Message Text="Grpc tools = $(GrpcTools)" Importance="High" />
    <Message Text="Protobuf tools = $(ProtobufTools)" Importance="High" />
    <MakeDir Directories="$(IntermediateOutputPath)" />
    <PropertyGroup>
      <GrpcToolsPath>$(GrpcTools)\tools\$(GrpcToolOs)_$(GrpcToolArch)</GrpcToolsPath>
      <ProtobufIncludePath>-I $(ProtobufTools)\tools</ProtobufIncludePath>
    </PropertyGroup>
    <Exec Command="$(GrpcToolsPath)/protoc.exe -I . $(ProtobufIncludePath) --csharp_out . --grpc_out . %(ProtocCodegen.Identity) --plugin=protoc-gen-grpc=$(GrpcToolsPath)/grpc_csharp_plugin.exe" 
      Condition="Exists('$(GrpcToolsPath)/protoc.exe')" />
    <ItemGroup>
      <Compile Include="@(ProtocGenCs)" />
      <Compile Include="@(ProtocGenGrpcCs)" Condition="Exists('%(Identity)')" />
      <None Update="@(ProtocGenCs)">
        <DependentUpon>%(FileName).proto</DependentUpon>
      </None>
      <None Update="@(ProtocGenGrpcCs)" Condition="Exists('%(Identity)')">
        <DependentUpon>$([System.String]::Copy('%(FileName).proto').Replace("Grpc", ""))</DependentUpon>
      </None>
    </ItemGroup>
    <Message Text="Compile: @(Compile)" Importance="High" />
  </Target>
</Project>
